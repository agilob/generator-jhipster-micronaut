dockerfile {
    baseImage = "openjdk:14-alpine"
    args("-Xmx256m")
}
dockerBuild {
    images = ["<%= baseName %>:$project.version"]
}

task copyIntoLayers (type: Copy) {
    from 'build/resources/main/'
    into 'build/layers/resources'
}

dockerBuild.dependsOn copyIntoLayers
dockerBuildNative.dependsOn copyIntoLayers

dockerfileNative {
    baseImage = "oracle/graalvm-ce:20.3.0-java11"
    args("-Xmx128m")
}
nativeImage {
    args('--static',
        '-H:Name=<%= dasherizedBaseName %>',
        '-H:Class=<%=packageName%>.<%=mainClass%>',
        '--no-fallback',
        '-H:+TraceClassInitialization',
        '-H:+ReportExceptionStackTraces',
        '-H:IncludeResourceBundles=liquibase/i18n/liquibase-core',
        '-H:ReflectionConfigurationFiles=resources/META-INF/native-image/<%=packageName%>/<%=dasherizedBaseName%>-<%=mainClass%>/reflection.json',
        '-H:ResourceConfigurationFiles=resources/META-INF/native-image/<%=packageName%>/<%=dasherizedBaseName%>-<%=mainClass%>/resources.json',
        '--report-unsupported-elements-at-runtime'
    )
}
dockerBuildNative {
    images = ["<%= baseName %>:$project.version"]
}
